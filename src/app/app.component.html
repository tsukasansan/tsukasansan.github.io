<div class="app-body">

    <app-loading [hidden]="isWeb3Connected"
                 [retryConnect]="retryConnect"></app-loading>


    <app-admin [playContract]="playContractObject"
               *ngIf="isAdminOpen"></app-admin>

    <div [ngClass]="{'is-loaded': isWeb3Connected}"
         class="app-content">

        <app-tutorial></app-tutorial>

        <header>
            <h1 class="logo-pic">
                life lottery <i>beta</i>
            </h1>
            <div class="right">
                <div *ngIf="!account?.address"
                     class="meta-mask">
                    Please <strong>unlock</strong> MetaMask <img src="../assets/images/metamask.png">
                </div>
                <a class="slack"
                   href="https://lifelottery.herokuapp.com/"
                   target="_blank"><img src="../assets/images/slack.png"> Join us!</a>
                <button (click)="howToPlay()">See tutorial</button>
            </div>
        </header>

        <div class="container">

            <div class="container__label">
                <h1>
                    Try your luck with<br>
                    blockchain lottery
                </h1>
            </div>

            <div class="container--flex">
                <section class="lottery-list" [ngClass]="{'is-play': isPlay}">

                    <ul>
                        <li *ngFor="let contract of contracts"
                            id="{{contract.address}}"
                            [ngStyle]="{'transform': contract.contractData.scale}">

                            <div *ngIf="isOnwer">
                                <button (click)="isAdminOpen = true">admin</button>
                            </div>

                            <a [ngClass]="{'is-closed': !contract.contractData.open}"
                               (click)="play(contract.contractData.address)">
                                <h1>
                                    <span [innerHtml]="contract.contractData.jackpotCalculated"></span>
                                    <i>eth</i>
                                </h1>

                                <app-lottery-icon contractAddress="{{contract.address}}"></app-lottery-icon>

                                <div *ngIf="contract.contractData.open">
                                    bets
                                    <div *ngIf="contract.contractData.fee == 0">
                                        <span
                                                [innerHtml]="contract.contractData.balance"></span>
                                        /
                                        <span [innerHtml]="contract.contractData.jackpot"></span>
                                    </div>
                                    <div *ngIf="contract.contractData.fee != 0">
                                        <span
                                                [innerHtml]="calculateCurrentBets(contract.contractData.balance,contract.contractData.fee)"></span>
                                        /
                                        <span [innerHtml]="calculateTotalBets(contract.contractData.jackpot,contract.contractData.fee)"></span>
                                    </div>
                                </div>

                                <div *ngIf="!contract.contractData.open && (contract.contractData.resultHash !== '0x0000000000000000000000000000000000000000000000000000000000000000')">
                                    result <span [innerHtml]="contract.contractData.result"></span>
                                </div>

                            </a>
                        </li>
                    </ul>
                </section>

                <aside class="sidebar">

                    <div class="sidebar__account-info"
                         [hidden]="!account?.address">
                        <div class="balance">
                            Balance
                            <span>{{account?.balance/1000000000000000000}}</span>
                        </div>
                        <a href="//ropsten.etherscan.io/address/{{account?.address}}"
                           target="_blank">{{account?.address}}</a>
                    </div>

                    <h2 class="sidebar__title">My bets</h2>

                    <ul class="bets">

                        <h3 *ngIf="!bets?.length">
                            No Bets yet, go make your first!
                        </h3>

                        <div *ngIf="withdrawMessage"
                             class="bets__withdraw-error-message">
                            <h3 [innerHtml]="withdrawMessage"></h3>
                            <span (click)="withdrawMessage = null">dismiss</span>
                        </div>

                        <li *ngFor="let bet of bets"
                            [ngClass]="{'is-winner': bet?.isWinner}">

                            <app-lottery-icon contractAddress="{{bet?.contractAddress}}"></app-lottery-icon>

                            <!--BET-->
                            <div class="bets--bet">
                                <span [innerHtml]="bet?.bet" class="bets__bet"></span>
                                <span [innerHtml]="bet?.timestamp | date: 'HH:mm d/MM'"
                                      class="bets__date"></span>
                            </div>
                            <!--BET-->


                            <div class="bets__status">

                                <!--BET STATUS ERROR -->
                                <div class="bets__status--error"
                                     *ngIf="bet?.isInvalid && !bet?.isConfirmed">
                                    <a href="https://ropsten.etherscan.io/tx/{{bet?.transactionHash}}"
                                       target="_blank">
                                        Cancelled
                                    </a>
                                </div>

                                <!--BET STATUS PENDING -->
                                <div class="bets__status--pending"
                                     *ngIf="!bet?.isConfirmed && !bet?.isInvalid">
                                    <a (click)="openAddress(bet?.contractAddress)">
                                        Pending
                                    </a>
                                    <a href="https://ropsten.etherscan.io/tx/{{bet?.transactionHash}}"
                                       target="_blank">
                                        <span class="bets__status--withdraw">
                                            {{bet?.transactionHash}}
                                        </span>
                                    </a>
                                </div>

                                <!--BET STATUS CONFIRMED -->
                                <div class="bets__status--confirmed"
                                     *ngIf="bet?.isConfirmed && !bet?.isWinner">
                                    <a (click)="openTx(bet?.transactionHash)">
                                        <p>Confirmed</p>
                                        <span>
                                            <i [innerHtml]="bet?.fee/1000000000000000000"></i> eth
                                        </span>
                                    </a>
                                </div>

                                <!--BET STATUS WINNER :) -->
                                <div class="bets__status--winner"
                                     *ngIf="bet?.isWinner">WINNER!


                                    <div *ngIf="!bet?.withdrawHash">
                                        <button (click)="withdraw(bet)">withdraw</button>
                                    </div>
                                    <div *ngIf="bet?.withdrawHash">
                                        <a (click)="openTx(bet?.transactionHash)"
                                           [innerHtml]="bet?.withdrawHash"
                                           class="bets__status--withdraw">
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </li>
                    </ul>
                </aside>

                <div [ngClass]="{'is-play':isPlay}"
                     class="play-wrap">
                    <app-play [play]="playContractObject"
                              class="play"></app-play>
                </div>

            </div>
        </div>
    </div>
</div>

<div class="bubbles">
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
</div>
